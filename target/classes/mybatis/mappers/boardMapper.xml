<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardDB">

	<!-- select 쿼리 (1개) ==> 아직 안씀 -->
	<select id="selectBoard"  parameterType="String" resultType="BoardVO">
		select *
		from board 
		where id=#{id}
	</select>

	
	<!-- select 쿼리 (유저별 문의 내역) -->
	<select id="selectUserBoardList" parameterType="HashMap" resultType="BoardVO">
		select * 
		from board
        join problem
        join place
        join department 
		ON problem.place_code=place.code
		and board.problem_code=problem.code 
		and board.problem_place_code=place.code 
		and board.department_code=department.code 
		and users_id=#{id}
		
	<include refid="search" />
		
	</select>
	

	<!-- select 쿼리 (각 점별 문의 내역) -->
	<select id="selectBoardList" parameterType="com.lotte.storecare.commons.Criteria" resultType="BoardVO">

		SELECT seq,datetime,clearTime,place_detail,problem_detail,flag,department_code,dep_name,floor,users_id 
		FROM board 
		join problem 
		join place 
		join department 
		ON board.problem_code = problem.code 
		and problem.place_code=place.code 
		and board.problem_place_code=place.code 
		and board.department_code=department.code 
		and board.department_code=#{department_code}

		<include refid="searchPaging" />
		
	</select>
	
	<!-- 전체 문의 개수 -->
	<select id="gettotalcount" resultType="int">
		select count(seq)
		from board
		where seq > 0;
	</select>
	
	<!-- update 쿼리 (사용자가 문의 수정)-->	
	<update id="updateUserBoard" parameterType="boardVO">
		update board
		set problem_code=#{problem_code}, datetime=#{datetime}, problem_place_code=#{problem_place_code}, floor=#{floor} 
		where seq=#{seq}
	</update>
	
	<!-- update 쿼리 (관리가자 문의 처리)-->	
	<update id="updateBoard" parameterType="String">
		update board
		set flag=1,clearTime=now() 
		where seq=#{seq}
	</update>	
	
	<!-- delete 쿼리 (사용자가 삭제하는 문의)-->
	<delete id="deleteBoard" parameterType="int">
		delete from board where seq=#{seq}
	</delete>
		

	
	<!--  insert 쿼리 -->
	<insert id="insertBoard" parameterType="BoardVO">
		insert into board(floor, problem_code,problem_place_code,users_id,department_code)
		values(#{floor},#{problem_code},#{problem_place_code},#{users_id},#{department_code})
	</insert>
	
	
	

	
	
	
	
	
	<!-- 날짜별 및 문의처리현황별 조회 SQL -->
	<sql id="search">
		<choose>
			<when test="searchCondition == 'all'">
				<if test="startDate != null and endDate == null"> <!-- 시작날짜가 null이 아니고 끝날짜가 null 일 때 -->
					where  dateTime  &gt; #{startDate}
				</if>
				<!-- 시작날짜가 null이 아니고 끝날짜가 null이 아닐 때 -->
				<!-- endDate+1을 하는 이유는 범위가 endDate 미만 까지여서 endDate를 포함시키기 위함  -->
				<if test="startDate != null and endDate != null">
					where dateTime between #{startDate} and #{endDate}+1
				</if>
				<if test="startDate == null and endDate != null"> <!-- 시작날짜가 null이고 끝날짜가 null이 아닐 때 -->
					where dateTime &lt; #{endDate}+1
				</if>
				<if test=" startDate == null and endDate == null"> <!-- 시작날짜가 null이고 끝날짜가 null일 때 -->
					order by seq desc
				</if>
			</when>
			<!-- 문의처리현황이 처리 중 일 때 -->
			<when test="searchCondition == 'doing'">
				<if test="startDate != null and endDate == null"> <!-- 시작날짜가 null이 아니고 끝날짜가 null 일 때 -->
					where  flag=0
					and dateTime  &gt; #{startDate}
				</if>
				<if test="startDate != null and endDate != null"><!-- 시작날짜가 null이 아니고 끝날짜가 null이 아닐 때 -->
					where flag=0
					and dateTime between #{startDate} and #{endDate}+1
				</if>
				<if test="startDate == null and endDate != null"> <!-- 시작날짜가 null이고 끝날짜가 null이 아닐 때 -->
					where flag=0
					and dateTime &lt; #{endDate}+1
				</if>
				<if test=" startDate == null and endDate == null"> <!-- 시작날짜가 null이고 끝날짜가 null일 때 -->
					where flag=0
					order by seq desc
				</if>
			</when>
			<!-- 문의처리현황이 처리완료 일 때 -->
			<when test="searchCondition == 'done'">
				<if test="startDate != null and endDate == null"> <!-- 시작날짜가 null이 아니고 끝날짜가 null 일 때 -->
					where  flag=1
					and dateTime  &gt; #{startDate}
				</if>
				<if test="startDate != null and endDate != null"><!-- 시작날짜가 null이 아니고 끝날짜가 null이 아닐 때 -->
					where flag=1
					and dateTime between #{startDate} and #{endDate}+1
				</if>
				<if test="startDate == null and endDate != null"> <!-- 시작날짜가 null이고 끝날짜가 null이 아닐 때 -->
					where flag=1
					and dateTime &lt; #{endDate}+1
				</if>
				<if test=" startDate == null and endDate == null"> <!-- 시작날짜가 null이고 끝날짜가 null일 때 -->
					where flag=1
					order by seq desc
				</if>
			</when>		
		</choose>
	</sql>
	
	
	<!-- 날짜별 및 문의처리현황별 조회 및 페이징 SQL -->
	<sql id="searchPaging">
		<choose>
			<when test="searchCondition == 'all'">
				<if test="startDate != null and endDate == null"> <!-- 시작날짜가 null이 아니고 끝날짜가 null 일 때 -->
					where  dateTime  &gt; #{startDate}
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<!-- 시작날짜가 null이 아니고 끝날짜가 null이 아닐 때 -->
				<!-- endDate+1을 하는 이유는 범위가 endDate 미만 까지여서 endDate를 포함시키기 위함  -->
				<if test="startDate != null and endDate != null">
					where dateTime between #{startDate} and #{endDate}+1
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test="startDate == null and endDate != null"> <!-- 시작날짜가 null이고 끝날짜가 null이 아닐 때 -->
					where dateTime &lt; #{endDate}+1
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test=" startDate == null and endDate == null"> <!-- 시작날짜가 null이고 끝날짜가 null일 때 -->
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
			</when>
			<!-- 문의처리현황이 처리 중 일 때 -->
			<when test="searchCondition == 'doing'">
				<if test="startDate != null and endDate == null"> <!-- 시작날짜가 null이 아니고 끝날짜가 null 일 때 -->
					where  flag=0
					and dateTime  &gt; #{startDate}
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test="startDate != null and endDate != null"><!-- 시작날짜가 null이 아니고 끝날짜가 null이 아닐 때 -->
					where flag=0
					and dateTime between #{startDate} and #{endDate}+1
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test="startDate == null and endDate != null"> <!-- 시작날짜가 null이고 끝날짜가 null이 아닐 때 -->
					where flag=0
					and dateTime &lt; #{endDate}+1
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test=" startDate == null and endDate == null"> <!-- 시작날짜가 null이고 끝날짜가 null일 때 -->
					where flag=0
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
			</when>
			<!-- 문의처리현황이 처리완료 일 때 -->
			<when test="searchCondition == 'done'">
				<if test="startDate != null and endDate == null"> <!-- 시작날짜가 null이 아니고 끝날짜가 null 일 때 -->
					where  flag=1
					and dateTime  &gt; #{startDate}
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test="startDate != null and endDate != null"><!-- 시작날짜가 null이 아니고 끝날짜가 null이 아닐 때 -->
					where flag=1
					and dateTime between #{startDate} and #{endDate}+1
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test="startDate == null and endDate != null"> <!-- 시작날짜가 null이고 끝날짜가 null이 아닐 때 -->
					where flag=1
					and dateTime &lt; #{endDate}+1
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
				<if test=" startDate == null and endDate == null"> <!-- 시작날짜가 null이고 끝날짜가 null일 때 -->
					where flag=1
					order by seq desc
					order by seq desc, datetime desc
					limit #{pageStart}, 5
				</if>
			</when>		
		</choose>
	</sql>
	
	
</mapper>